<!--

    Copyright (c) Istituto Nazionale di Fisica Nucleare (INFN). 2016-2021

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div ng-controller="RegistrationController as rc">
	<link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
	<h2 class="text-center">
		Register at <strong>{{organisationName}}</strong>
	</h2>
	<div class="ext-authn-info" ng-show="extAuthInfo != null">
		<p>
			This is the <strong>{{organisationName}}</strong> registration page.
		</p>
		<p>
			You have been succesfully authenticated, but your credentials are <strong>not</strong>
			yet linked to an <strong>{{organisationName}}</strong> account.
		</p>
		<p>To proceed with the registration please fill in your personal
			information below.</p>
		<p>
			To abort this registration click <a href="/reset-session">here</a>.
		</p>
	</div>
	<div class="ext-authn-info" ng-show="extAuthInfo == null">
		<p>This is the {{organisationName}} registration page.</p>
		<p ng-show="getExternablAuthenticationEnabled()">
			If you want to register using an external identity provider, like
			Google or your institution identity provider, head back to the <a
				href="/login">login page</a> and click the "Sign in with" button of
			your preferred identity provider.
		</p>

		
		<!-- This one I get  -->
		<p ng-if="!iamX509Cred && iamX509Required === 'REQUIRED'" style="color: red; font-size: 24px; font-family: 'Comic Neue', cursive, sans-serif;" >
					A certificate is required upon <br> registration, but none were presented.
					Please link a certificate to your<br> browser.
		</p>

		<!-- In case certificate is REQUIRED, but it is already linked  -->
		<div id="x509-authn-info" ng-if="iamX509Cred && iamX509Required === 'REQUIRED' && (iamX509CanLogin || iamX509SuspendedAccount)">
				You have been succesfully authenticated as<br>
				<strong>{{iamX509Subject}}</strong> <br> <br>
			
				<p ng-if="iamX509AlmostExpired" style="color: red;">
					This certificate will expire within a month <br>
					Specifically at {{iamX509ExpirationDate}} <br> <br>
				</p>

		</div>

		<!-- In case certificate is REQUIRED and it is linked to another account -->
		<p ng-if="iamX509Required === 'REQUIRED' && iamX509CanLogin && iamX509Cred" style="color: red; font-size: 24px; font-family: 'Comic Neue', cursive, sans-serif;">
			This certificate is already linked to an account in the organization and can not be linked to multiple accounts.
			Please add a different certificate to the browser. 
		</p>

		<!-- In case certificate is REQUIRED and it is linked to an suspended account -->
		<p ng-if="iamX509Required === 'REQUIRED' && iamX509SuspendedAccount" style="color: red; font-size: 24px; font-family: 'Comic Neue', cursive, sans-serif;">
			This certificate is linked to a<br> suspended account in this<br> organization.
			<br><br>Please add a different<br> certificate to the browser or confer with the admin why the linked account is suspended.
		</p>


		<p ng-if="iamX509Required === 'OFF' || iamX509Required === 'OPTIONAL' || (iamX509Required === 'REQUIRED' && iamX509Cred && !iamX509CanLogin && !iamX509SuspendedAccount) ">
			To proceed with the registration please fill in your personal
			information below.</p>
	</div>

	<div class="box box-default no-border registration-box">
		<form name="registrationForm" id="registration-form">
			<div ng-show="operationResult != null">
				<div class="alert"
					ng-class="{'alert-success': operationResult=='ok', 'alert-danger': operationResult=='err'}">
					<button class="close" ng-click="operationResult=null"
						aria-label="close">&times;</button>
					{{textAlert}}
				</div>
			</div>

			<!-- Dynamic form fields generated from the controller's fields array -->
			<div ng-repeat="field in fields">
				<div class="form-group" ng-if="field.showField && !(iamX509Required === 'REQUIRED') || (iamX509Cred && !iamX509CanLogin && !iamX509SuspendedAccount)"
					ng-class="{'has-error': rc.fieldInvalid(field.name), 'has-success': rc.fieldValid(field.name)}">
					<label class="control-label" for="{{field.name}}">{{field.label}}</label>

					<!-- Field where applying custom directive is NOT needed -->
					<input ng-if="field.type == 'text' && field.name != 'username'"
						class="form-control" name="{{field.name}}" id="{{field.name}}"
						type="{{field.type}}" ng-model="request[field.ngModelName]"
						placeholder="{{field.placeholder}}" ng-required="field.required"
						ng-minlength="field.minlength"
						ng-readonly="rc.fieldReadonly(field.name)"
						ng-model-options="{ debounce: field.debounceTime || 0 }" />

					<!-- Field where applying custom directive directly is a MUST -->
					<input ng-if="field.type == 'email'" class="form-control"
						name="{{field.name}}" id="{{field.name}}" type="{{field.type}}"
						ng-model="request[field.ngModelName]"
						placeholder="{{field.placeholder}}" ng-required="field.required"
						ng-minlength="field.minlength"
						ng-readonly="rc.fieldReadonly(field.name)"
						ng-model-options="{ debounce: field.debounceTime || 0 }"
						iam-email-available-validator />

					<!-- Field where applying custom directive directly is a MUST -->
					<input ng-if="field.type == 'text' && field.name == 'username'"
						class="form-control" name="{{field.name}}" id="{{field.name}}"
						type="{{field.type}}" ng-model="request[field.ngModelName]"
						placeholder="{{field.placeholder}}" ng-required="field.required"
						ng-minlength="field.minlength"
						ng-readonly="rc.fieldReadonly(field.name)"
						ng-model-options="{ debounce: field.debounceTime || 0 }"
						iam-username-available-validator />

					<textarea ng-if="field.type === 'textarea'" class="form-control"
						id="{{field.name}}" name="{{field.name}}" rows="{{field.rows}}"
						placeholder="{{field.placeholder}}"
						ng-model="request[field.ngModelName]" ng-required="field.required"
						ng-minlength="{{field.minlength}}"
						ng-readonly="rc.fieldReadonly(field.name)"></textarea>

					<span class="help-block"
						ng-show="registrationForm[field.name].$dirty && rc.getFieldErrorMessage(field.name)">
						{{ rc.getFieldErrorMessage(field.name) }} </span>
				</div>
			</div>

			<div id = "checkbox" ng-attr-title="{{(request.registerCertificate) ? 'Un-check to not link your certificate to the account' : 'Check to link your certificate to the account'}}" 
				ng-if = "iamX509Required === 'OPTIONAL'">

				<label for="register-certificate" ng-style="(request.registerCertificate && (iamX509SuspendedAccount || iamX509CanLogin)) ? {'color' : 'red'} : {}">
					Register certificate
				</label><br>

				<input type="checkbox" id="register-certificate" name="register-certificate"  ng-model="request.registerCertificate">

				<!-- Certificate is already linked -->
				<span ng-if = "(iamX509Required === 'OPTIONAL') && iamX509CanLogin && request.registerCertificate" style="color: red;">
					Certificate is already linked to an account. It can not be linked
				</span>

				<!-- Certificate is linked to a blocked account -->
				<span ng-if = "(iamX509Required === 'OPTIONAL') && iamX509SuspendedAccount && request.registerCertificate" style="color: red;">
					Certificate is linked to an suspended account. It can not be linked
				</span>
				
				<!-- Certificate is not present in the browser -->
				<span ng-if = "(iamX509Required === 'OPTIONAL') &&!iamX509Cred && request.registerCertificate" style="color: red;">
					No certificate present to link. Not possible to link certificate
				</span>

				<!-- No errors or the box is not checked -->
				<span ng-if = "(iamX509Required === 'OPTIONAL') && ((!iamX509SuspendedAccount && !iamX509CanLogin && iamX509Cred && request.registerCertificate) || !request.registerCertificate)">
					Link your certificate to the account 
				</span>

				<br><br>

			</div>

			<div ng-if="!aup && privacyPolicy.url">
				<p>
					By submitting this registration request, you declare that you agree
					with the terms of this organization <a href="{{privacyPolicy.url}}">{{privacyPolicy.text}}</a>.
				</p>
			</div>
			<div ng-if="aup && aup.text">
				<div class="form-group">
					<label class="control-label">Acceptable Usage Policy (AUP)</label>
					<div>{{aup.text}}</div>
					<p class="help-block" ng-if="privacyPolicy.url == null">By
						submitting this registration request, you agree to the terms of
						this organization Acceptable Usage Policy shown above.</p>
					<p class="help-block" ng-if="privacyPolicy.url != null">
						By submitting this registration request, you agree to the terms of
						this organization Acceptable Usage Policy shown above and <a
							target="_blank" rel="noopener noreferrer"
							href="{{privacyPolicy.url}}">{{privacyPolicy.text}}</a>.
					</p>
				</div>
			</div>
			<div ng-if="aup && aup.url">
				<div class="form-group">
					<p ng-if="!privacyPolicy.url">
						By submitting this registration request, you declare that you
						agree with the terms of this organization <a target="_blank"
							rel="noopener noreferrer" href="{{aup.url}}">Acceptable Usage
							Policy</a>.
					</p>
					<p ng-if="privacyPolicy.url">
						By submitting this registration request, you declare that you
						agree with the terms of this organization <a href="{{aup.url}}">Acceptable
							Usage Policy</a> and <a target="_blank" rel="noopener noreferrer"
							href="{{privacyPolicy.url}}">{{privacyPolicy.text}}</a>.
					</p>
				</div>
			</div>
			<div class="form-group" ng-if = "!(iamX509Required === 'REQUIRED') || (iamX509Cred && !iamX509CanLogin && !iamX509SuspendedAccount)">
				<button class="btn btn-primary" type="submit"
					id="register-submit-btn" name="register"
					ng-disabled="!registrationForm.$valid || busy || (iamX509Required === 'OPTIONAL' && request.registerCertificate && (iamX509CanLogin || iamX509SuspendedAccount || !iamX509Cred))"
					ng-click="rc.submit()">Register</button>
				<button class="btn btn-warning" type="button"
					id="register-reset-btn" name="reset" ng-click="rc.reset()"
					ng-disabled="registrationForm.$pristine">Reset Form</button>
	
			</div>
			<div id="x509-authn-info" ng-if="iamX509Cred && (iamX509Required === 'OPTIONAL' || (iamX509Required === 'REQUIRED' && !iamX509CanLogin && !iamX509SuspendedAccount))">
				You have been succesfully authenticated as, {{registerCertificate}}<br>
				<strong>{{iamX509Subject}}</strong>

				<p ng-if="!iamX509CanLogin && !iamX509SuspendedAccount">
					This certificate is not linked to any account in the organization.
				</p>
			
				<p ng-if="iamX509AlmostExpired" style="color: red;">
					This certificate will expire within a month <br>
					Specifically at {{iamX509ExpirationDate}}
				</p>

			</div>

		</form>
		<div class="overlay" ng-if="busy">
			<i class="fa fa-refresh fa-spin"></i>
		</div>
	</div>
</div>